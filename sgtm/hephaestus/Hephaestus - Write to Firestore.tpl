___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Hephaestus - Write to Firestore",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Writes data to a specified Firestore Document. Includes option to choose whether the tag will overwrite, edit, or leave unchanged the document or attributes within a document.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "GCP data",
    "displayName": "Provide your Google Cloud Project information",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "gcpProjectId",
        "displayName": "GCP Project ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "collectionId",
        "displayName": "Firestore Collection ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "documentId",
        "displayName": "Firestore Document ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "Attributes",
    "displayName": "Provide list of attributes you would like to write in Firestore",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "action",
        "displayName": "Behaviour",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "replace",
            "displayValue": "Replace entire document"
          },
          {
            "value": "editOrAdd",
            "displayValue": "Edit or add attributes"
          }
        ],
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "alwaysInSummary": false,
        "help": "Specifies whether the tag will overwrite, edit, or leave unchanged the entire document or values with in the document."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "attributesReplace",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Attribute",
            "name": "attribute",
            "type": "TEXT",
            "selectItems": [],
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "macrosInSelect": true
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "macrosInSelect": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY",
            "errorMessage": "Please select at least 1 parameter"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "replace",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "attributesEditAdd",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Attribute",
            "name": "attribute",
            "type": "TEXT",
            "selectItems": [],
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "macrosInSelect": true
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "macrosInSelect": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Overwrite if exists",
            "name": "overwrite",
            "type": "SELECT",
            "selectItems": [
              {
                "value": true,
                "displayValue": "Yes"
              },
              {
                "value": false,
                "displayValue": "No"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY",
            "errorMessage": "Please select at least 1 parameter"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "editOrAdd",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

const Firestore = require('Firestore');
const log = require('logToConsole');
const Promise = require('Promise');
const firestorePath = data.collectionId + '/' + data.documentId;
const eventData = {};

function writeToFirestore(path, input, replace){
  Firestore.write(path, input, {
    projectId: data.gcpProjectId,
    merge: replace,
  }).then(() => {
    log('Firestore success: ', input);
    data.gtmOnSuccess();
  },data.gtmOnFailure);
}



function getFirestoreValue(path, attributes) {

  return Promise.create((resolve) => {
    return Firestore.read(path, { projectId: data.gcpProjectId })
      .then((result) => {
      
      attributes.forEach(param => {
        if(param.overwrite === true && param.value){
          eventData[param.attribute] = param.value;
        }
        if(param.overwrite === false && param.value){
            if(!result.data.hasOwnProperty(param.attribute)){
              eventData[param.attribute] = param.value;
            }
        }
      });
    })
      .catch((error) => {
      if(error.reason === 'not_found'){
        attributes.forEach(param => {
          if(param.value){
            eventData[param.attribute] = param.value;
          }
        });
      } else {
      log(error);
      }
    })
      .finally(() => {
      resolve(writeToFirestore(firestorePath, eventData, true));
    });
  });
}

  
if(data.action === 'replace'){
  data.attributesReplace.forEach(param => {
    if(param.value){
      eventData[param.attribute] = param.value;
    }
  });
  writeToFirestore(firestorePath, eventData, false);
}


if(data.action === 'editOrAdd') {
  getFirestoreValue(firestorePath, data.attributesEditAdd); 
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_firestore",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedOptions",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "read_write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 5/10/2024, 12:25:49 PM


